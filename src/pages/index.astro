---
import CTA from "../components/landing/CTA.astro";
import Features from "../components/landing/Features.astro";
import Hero from "../components/landing/Hero.astro";
import SignInCard from "../components/landing/SignInCard.astro";
import Navigation from "../components/layout/Navigation.astro";
import Layout from "../layouts/Layout.astro";
import { getAuthErrorMessage, getAuthSuccessMessage } from "../lib/auth";
import { createSupabaseServerClient } from "../lib/db-client";
import { createUserService } from "../lib/users";

const supabase = createSupabaseServerClient();
const users = createUserService(supabase, Astro.cookies);
const user = await users.getCurrentUser();
const isAuthenticated = !!user;
const search = Astro.url.searchParams;
const errorCode = search.get("error");
const errorMessage = getAuthErrorMessage(errorCode);
const successCode = search.get("success");
const successMessage = getAuthSuccessMessage(successCode);
const emailPrefill = search.get("email") ?? "";

// Handle password reset redirects
const token = search.get("token");
const type = search.get("type");
if (token && type === "recovery") {
	// Redirect to recover page with the token
	return Astro.redirect(
		`/auth/recover?token=${encodeURIComponent(token)}&type=${encodeURIComponent(type)}`,
	);
}
---

<Layout title="Serverless App Quickstart" description="A modern serverless application template built with Astro and Supabase">
  <div class="min-h-screen bg-white">
    <Navigation user={user || undefined} />
    
    <Hero isAuthenticated={isAuthenticated} />

    {!isAuthenticated && (
      <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 sm:mt-20 md:mt-24 lg:mt-32">
        <SignInCard
          emailPrefill={emailPrefill}
          errorMessage={errorMessage}
          successMessage={successMessage}
        />
      </section>
    )}
    
    <Features />
    <CTA isAuthenticated={isAuthenticated} />
  </div>
</Layout>
