---
import Navigation from "../components/layout/Navigation.astro";
import AccountManagement from "../components/profile/AccountManagement.astro";
import DangerZone from "../components/profile/DangerZone.astro";
import ProfilePreferences from "../components/profile/ProfilePreferences.astro";
import TimezoneMismatchBanner from "../components/TimezoneMismatchBanner.astro";
import Layout from "../layouts/Layout.astro";
import { getAuthErrorMessage } from "../lib/auth";
import { formatMessage } from "../lib/format";
import { createSupabaseServerClient } from "../lib/supabase";
import { getTimezoneOptions } from "../lib/timezones";
import { createUserService } from "../lib/users";

const supabase = createSupabaseServerClient();
const users = createUserService(supabase, Astro.cookies);

const authUser = await users.getCurrentUser();

if (!authUser) {
	console.error("Profile access attempted without authenticated user");
	return Astro.redirect("/");
}

const user = await users.getById(authUser.id);

if (!user) {
	console.error(
		`Auth user exists but database user record missing - ID: ${authUser.id}, email: ${
			authUser.email ?? "none"
		}, page: profile`,
	);
	return Astro.redirect("/?error=user_not_found");
}

const timezones = await getTimezoneOptions(supabase, {
	includeValues: [user.timezone],
});

const search = Astro.url.searchParams;
const error = search.get("error");
const success = search.get("success");
const errorMessage = getAuthErrorMessage(error);
const successMessage = formatMessage(success);
---

<Layout title="Profile" description="Edit your profile">
  <div class="min-h-screen bg-gray-50">
    <Navigation user={authUser} />
    
    <div class="max-w-3xl mx-auto px-6 py-12">
      
      <div class="mb-6">
        <a
          href="/dashboard"
          class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 font-medium"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to Dashboard
        </a>
      </div>
    
      <div class="space-y-6">
        {errorMessage && (
          <div class="p-4 rounded-md bg-red-50 border border-red-200 text-red-700" role="alert">
            {errorMessage}
          </div>
        )}

        {successMessage && (
          <div class="p-4 rounded-md bg-green-50 border border-green-200 text-green-700" role="alert">
            {successMessage}
          </div>
        )}

				<TimezoneMismatchBanner savedTimezone={user.timezone} />

        <AccountManagement
          email={user.email}
          phone={user.phone_number}
          phoneCountryCode={user.phone_country_code}
          phoneVerified={user.phone_verified}
        />

        <ProfilePreferences
          timezone={user.timezone}
          timezones={timezones}
        />
      </div>

      <div class="mt-6">
        <DangerZone />
      </div>
    </div>
  </div>
</Layout>

<script>
	import { setupTimezoneMismatchBanner } from "../lib/timezone-banner";

	function setupProfilePreferencesNavigationWarning() {
		const formElement = document.getElementById("profile-preferences-form");
		if (!(formElement instanceof HTMLFormElement)) {
			return;
		}
		const form = formElement;

		const saveButtonElement = document.getElementById("save-profile-preferences-button");
		if (!(saveButtonElement instanceof HTMLButtonElement)) {
			return;
		}
		const saveButton = saveButtonElement;

		let isDirty = false;
		let isSubmitting = false;

		function readFormValues() {
			const values = new Map();
			const elements = form.querySelectorAll("[name]");
			
			for (const element of elements) {
				const name = element.getAttribute("name");
				if (!name) continue;
				
				if (element instanceof HTMLInputElement) {
					if (element.type === "checkbox") {
						values.set(name, element.checked);
					} else if (element.type === "radio") {
						if (element.checked) {
							values.set(name, element.value);
						}
					} else {
						values.set(name, element.value);
					}
				} else if (element instanceof HTMLSelectElement || element instanceof HTMLTextAreaElement) {
					values.set(name, element.value);
				}
			}
			
			return values;
		}

		const initialValues = readFormValues();

		function checkIfDirty() {
			const currentValues = readFormValues();
			isDirty = Array.from(initialValues.entries()).some(([key, value]) => {
				return value !== currentValues.get(key);
			});
			return isDirty;
		}

		function updateSaveButtonState() {
			saveButton.disabled = !checkIfDirty();
		}

		function handleFormChange() {
			updateSaveButtonState();
		}

		form.addEventListener("input", handleFormChange);
		form.addEventListener("change", handleFormChange);

		form.addEventListener("submit", () => {
			isSubmitting = true;
			isDirty = false;
		});

		window.addEventListener("beforeunload", (event) => {
			if (isSubmitting) {
				return;
			}
			if (checkIfDirty()) {
				event.preventDefault();
				event.returnValue = "";
				return "";
			}
		});

		function shouldWarnOnLinkClick(link: HTMLAnchorElement): boolean {
			if (!checkIfDirty()) {
				return false;
			}

			if (link.target === "_blank") {
				return false;
			}

			const href = link.getAttribute("href");
			if (!href || href.startsWith("#") || href.startsWith("javascript:")) {
				return false;
			}

			try {
				const destination = new URL(link.href, window.location.href);
				const current = new URL(window.location.href);

				const isSamePage =
					destination.origin === current.origin &&
					destination.pathname === current.pathname &&
					destination.search === current.search;

				if (isSamePage) {
					return false;
				}
			} catch {
				return false;
			}

			return href.startsWith("/") || href.startsWith("http");
		}

		document.addEventListener("click", (event) => {
			const target = event.target;
			if (!(target instanceof Element)) {
				return;
			}

			const link = target.closest("a");
			if (!link || !shouldWarnOnLinkClick(link)) {
				return;
			}

			if (!confirm("You have unsaved changes. Are you sure you want to leave this page?")) {
				event.preventDefault();
				event.stopPropagation();
			}
		}, true);

		updateSaveButtonState();
	}

	function setupProfileTimezoneMismatchBanner() {
		const banner = document.getElementById("timezone-mismatch-banner");
		if (!(banner instanceof HTMLElement)) {
			return;
		}

		const savedTimezone = banner.dataset.savedTimezone ?? "";
		setupTimezoneMismatchBanner(savedTimezone);
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", () => {
			setupProfileTimezoneMismatchBanner();
			setupProfilePreferencesNavigationWarning();
		});
	} else {
		setupProfileTimezoneMismatchBanner();
		setupProfilePreferencesNavigationWarning();
	}
</script>