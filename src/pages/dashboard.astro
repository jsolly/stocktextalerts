---
import { readFile } from "node:fs/promises";
import DashboardPreferencesForm from "../components/dashboard/DashboardPreferencesForm.astro";
import SetupRequiredBanner from "../components/dashboard/SetupRequiredBanner.astro";
import Navigation from "../components/layout/Navigation.astro";
import Layout from "../layouts/Layout.astro";
import { formatMessage } from "../lib/format";
import type { Stock } from "../lib/stocks";
import { getUserStocks } from "../lib/stocks";
import { createSupabaseServerClient } from "../lib/supabase";
import { getTimezoneOptions } from "../lib/timezones";
import { createUserService } from "../lib/users";

const supabase = createSupabaseServerClient();
const users = createUserService(supabase, Astro.cookies);

const authUser = await users.getCurrentUser();

if (!authUser) {
	console.error("Dashboard access attempted without authenticated user");
	return Astro.redirect("/");
}

const user = await users.getById(authUser.id);

if (!user) {
	console.error(
		`Auth user exists but database user record missing - ID: ${authUser.id}, email: ${
			authUser.email ?? "none"
		}, page: dashboard`,
	);
	return Astro.redirect("/?error=user_not_found");
}

const stocksFileUrl = new URL("../../scripts/us-stocks.json", import.meta.url);
const stocksFileContents = await readFile(stocksFileUrl, "utf-8");
const { data: allStocks } = JSON.parse(stocksFileContents) as { data: Stock[] };

const [userStocks, timezones] = await Promise.all([
	getUserStocks(supabase, authUser.id),
	getTimezoneOptions(supabase),
]);

const stockOptions = allStocks.map((stock) => ({
	value: stock.symbol,
	label: `${stock.symbol} - ${stock.name}`,
}));

const url = new URL(Astro.request.url);
const successMessage = url.searchParams.get("success");
const errorMessage = url.searchParams.get("error");
const isEditingPhone = url.searchParams.get("change_phone") === "1";
---

<Layout title="Dashboard" description="Review and manage your stock notifications">
	<div class="min-h-screen bg-gray-50">
		<Navigation user={authUser} />
		
		<div class="max-w-4xl mx-auto px-6 py-12">
			<div class="mb-8">
				<h1 class="text-4xl font-bold text-gray-900 mb-2">Dashboard</h1>
				<p class="text-lg text-gray-600">Configure your notification preferences and track stocks</p>
			</div>

		{successMessage && (
			<div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4" role="alert">
				<p class="text-green-800">{formatMessage(successMessage)}</p>
			</div>
		)}

		{errorMessage && (
			<div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4" role="alert">
				<p class="text-red-800">{formatMessage(errorMessage)}</p>
			</div>
		)}

		<!-- Section 1: Setup Required Banner -->
		<SetupRequiredBanner user={user} />

		<!-- Section 2: Preferences form (stocks + notification settings) -->
		<DashboardPreferencesForm
			user={user}
			timezones={timezones}
			stockOptions={stockOptions}
			initialSymbols={userStocks.map((stock) => stock.symbol)}
			isEditingPhone={isEditingPhone}
		/>
		</div>
	</div>
</Layout>


