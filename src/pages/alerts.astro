---
import Navigation from "../components/Navigation.astro";
import PhoneInput from "../components/PhoneInput.vue";
import StockInput from "../components/StockInput.vue";
import Layout from "../layouts/Layout.astro";
import { getAllStocks, getUserStocks } from "../lib/stocks";
import { createSupabaseServerClient } from "../lib/supabase";
import { createUserService } from "../lib/users";

const supabase = createSupabaseServerClient();
const users = createUserService(supabase, Astro.cookies);

const authUser = await users.getCurrentUser();

if (!authUser) {
	return Astro.redirect("/");
}

const user = await users.getById(authUser.id);
const allStocks = await getAllStocks(supabase);
const userStocks = await getUserStocks(supabase, authUser.id);

const stockOptions = allStocks.map((stock) => ({
	value: stock.symbol,
	label: `${stock.symbol} - ${stock.name}`,
}));

const url = new URL(Astro.request.url);
const successMessage = url.searchParams.get("success");
const errorMessage = url.searchParams.get("error");

const needsSetup =
	(user.notify_via_sms && !user.phone_verified) ||
	(!user.notify_via_email && !user.notify_via_sms);

const US_TIMEZONES = [
	{ value: "America/New_York", label: "Eastern Time (ET)" },
	{ value: "America/Chicago", label: "Central Time (CT)" },
	{ value: "America/Denver", label: "Mountain Time (MT)" },
	{ value: "America/Phoenix", label: "Mountain Time - Arizona (MT)" },
	{ value: "America/Los_Angeles", label: "Pacific Time (PT)" },
	{ value: "America/Anchorage", label: "Alaska Time (AKT)" },
	{ value: "Pacific/Honolulu", label: "Hawaii Time (HT)" },
];

const hours = Array.from({ length: 24 }, (_, i) => i);
---

<Layout title="Stock Alerts" description="Manage your stock alerts">
	<div class="min-h-screen bg-gray-50">
		<Navigation user={authUser} />
		
		<div class="max-w-4xl mx-auto px-6 py-12">
			<div class="mb-8">
				<h1 class="text-4xl font-bold text-gray-900 mb-2">Stock Alerts</h1>
				<p class="text-lg text-gray-600">Configure your notification preferences and track stocks</p>
			</div>

			{successMessage && (
				<div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
					<p class="text-green-800">{successMessage.replace(/_/g, ' ')}</p>
				</div>
			)}

			{errorMessage && (
				<div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
					<p class="text-red-800">{errorMessage.replace(/_/g, ' ')}</p>
				</div>
			)}

			<!-- Section 1: Setup Required Banner -->
			{needsSetup && (
				<div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
					<h2 class="text-xl font-semibold text-yellow-900 mb-2">Setup Required</h2>
					<p class="text-yellow-800 mb-4">Please complete your setup to receive alerts:</p>
					<ul class="list-disc list-inside text-yellow-800 space-y-1">
						{user.notify_via_sms && !user.phone_verified && (
							<li>Verify your phone number below</li>
						)}
						{!user.notify_via_email && !user.notify_via_sms && (
							<li>Enable at least one notification method</li>
						)}
						{!user.timezone && (
							<li>Set your timezone in preferences</li>
						)}
					</ul>
				</div>
			)}

			<!-- Section 2: Phone Setup (conditional) -->
			{user.notify_via_sms && (
				<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
					<h2 class="text-2xl font-bold text-gray-900 mb-4">Phone Verification</h2>
					
					{user.sms_opted_out && (
						<div class="mb-4 bg-red-50 border border-red-200 rounded-lg p-4">
							<p class="text-red-800">You have opted out of SMS alerts. Reply START to your last message to re-enable.</p>
						</div>
					)}

					{user.phone_verified ? (
						<div class="bg-green-50 border border-green-200 rounded-lg p-4">
							<p class="text-green-800">âœ“ Phone verified: {user.phone_country_code} {user.phone_number}</p>
						</div>
					) : (
						<div>
							<form method="POST" action="/api/phone/send-verification" class="space-y-4">
								<PhoneInput client:only="vue" />
								<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
									Send Verification Code
								</button>
							</form>

							{user.phone_number && !user.phone_verified && (
								<form method="POST" action="/api/phone/verify-code" class="mt-6 space-y-4">
									<div>
										<label for="code" class="block text-sm font-medium text-slate-700 mb-1">
											Enter Verification Code
										</label>
										<input type="text" id="code" name="code" required
											class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
											placeholder="123456" />
									</div>
									<button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
										Verify Code
									</button>
								</form>
							)}
						</div>
					)}
				</div>
			)}

			<!-- Section 3: Notification Preferences -->
			<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
				<h2 class="text-2xl font-bold text-gray-900 mb-4">Notification Preferences</h2>
				
				<form method="POST" action="/api/preferences/update" class="space-y-6">
					<div>
						<label class="block text-sm font-medium text-slate-700 mb-2">
							Notification Methods (select at least one)
						</label>
						<div class="space-y-2">
							<label class="flex items-center">
								<input type="checkbox" name="notify_via_email" class="mr-2" checked={user.notify_via_email} />
								<span>Email Notifications</span>
							</label>
							<label class="flex items-center">
								<input type="checkbox" name="notify_via_sms" class="mr-2" checked={user.notify_via_sms} />
								<span>SMS Notifications</span>
							</label>
						</div>
					</div>

					<div>
						<label for="timezone" class="block text-sm font-medium text-slate-700 mb-1">
							Timezone <span class="text-red-500">*</span>
						</label>
						<select id="timezone" name="timezone" required
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="">Select your timezone</option>
							{US_TIMEZONES.map(tz => (
								<option value={tz.value} selected={user.timezone === tz.value}>
									{tz.label}
								</option>
							))}
						</select>
					</div>

					<div class="grid grid-cols-2 gap-4">
						<div>
							<label for="notification_start_hour" class="block text-sm font-medium text-slate-700 mb-1">
								Start Hour (24h format)
							</label>
							<select id="notification_start_hour" name="notification_start_hour"
								class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
								{hours.map(hour => (
									<option value={hour} selected={user.notification_start_hour === hour}>
										{String(hour).padStart(2, '0')}:00
									</option>
								))}
							</select>
						</div>
						<div>
							<label for="notification_end_hour" class="block text-sm font-medium text-slate-700 mb-1">
								End Hour (24h format)
							</label>
							<select id="notification_end_hour" name="notification_end_hour"
								class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
								{hours.map(hour => (
									<option value={hour} selected={user.notification_end_hour === hour}>
										{String(hour).padStart(2, '0')}:00
									</option>
								))}
							</select>
						</div>
					</div>

					<button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
						Save Preferences
					</button>
				</form>
			</div>

			<!-- Section 4: Stock Selection -->
			<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
				<h2 class="text-2xl font-bold text-gray-900 mb-4">Tracked Stocks</h2>
				
				<div class="mb-6">
					<h3 class="text-lg font-semibold text-gray-900 mb-3">Add Stock</h3>
					<StockInput client:only="vue" stockOptions={stockOptions} />
					<form method="POST" action="/api/stocks/add" id="add-stock-form" class="hidden">
						<input type="hidden" name="symbol" id="symbol-to-add" />
					</form>
				</div>

				<div>
					<h3 class="text-lg font-semibold text-gray-900 mb-3">Your Stocks</h3>
					{userStocks.length === 0 ? (
						<p class="text-gray-500">No stocks tracked yet. Add your first stock above.</p>
					) : (
						<div class="space-y-2">
							{userStocks.map(stock => (
								<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
									<span class="font-medium text-gray-900">{stock.symbol}</span>
									<form method="POST" action="/api/stocks/remove">
										<input type="hidden" name="symbol" value={stock.symbol} />
										<button type="submit" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
											Remove
										</button>
									</form>
								</div>
							))}
						</div>
					)}
				</div>
			</div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			const stockInput = document.querySelector('#stock_search');
			if (stockInput) {
				stockInput.addEventListener('stock-selected', ((e: CustomEvent) => {
					const symbol = e.detail.symbol;
					const form = document.getElementById('add-stock-form') as HTMLFormElement;
					const input = document.getElementById('symbol-to-add') as HTMLInputElement;
					input.value = symbol;
					form.submit();
				}) as EventListener);
			}

			if (!navigator || !('timeZone' in Intl.DateTimeFormat().resolvedOptions())) {
				return;
			}

			const timezoneSelect = document.getElementById('timezone') as HTMLSelectElement;
			if (timezoneSelect && !timezoneSelect.value) {
				const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
				const option = timezoneSelect.querySelector(`option[value="${detectedTimezone}"]`);
				if (option) {
					timezoneSelect.value = detectedTimezone;
				}
			}
		});
	</script>
</Layout>

