---
import type { TimezoneOption } from "../../lib/timezones/timezones";

interface Props {
	timezone: string;
	timezones: TimezoneOption[];
}

const { timezone, timezones } = Astro.props;
---

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
	<h2 class="text-2xl font-bold text-gray-900 mb-4">Preferences</h2>

	<form
		id="profile-preferences-form"
		method="POST"
		action="/api/preferences/profile"
		class="space-y-6"
	>
		<div>
			<label
				for="timezone"
				class="block text-sm font-medium text-slate-700 mb-1"
			>
				Timezone <span class="text-red-500">*</span>
			</label>
			<select
				id="timezone"
				name="timezone"
				required
				class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
			>
			<option value="" disabled hidden>
				Select your timezone
			</option>
				{timezones.map((tz) => (
					<option value={tz.value} selected={timezone === tz.value}>
						{tz.label}
					</option>
				))}
			</select>
		</div>

		<div class="pt-4">
			<!-- Button enabled by default for non-JS users; disabled by JS when form is pristine -->
			<button
				type="submit"
				id="save-profile-preferences-button"
				class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed"
			>
				Save Preferences
			</button>
		</div>
	</form>
</div>

<script>
	import { setupDetectedTimezoneOption } from "../../lib/timezones/timezone-select";
	import { DEFAULT_TIMEZONE } from "../../lib/timezones/timezone-constants";
	import { setupFormChangeDetection } from "../../lib/forms/change-detection";

	function initializeFormState() {
		const formElement = document.getElementById("profile-preferences-form");
		const saveButtonElement = document.getElementById("save-profile-preferences-button");
		
		if (!(formElement instanceof HTMLFormElement) || !(saveButtonElement instanceof HTMLButtonElement)) {
			return;
		}

		setupFormChangeDetection(formElement, saveButtonElement);
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", () => {
			setupDetectedTimezoneOption({ defaultTimezone: DEFAULT_TIMEZONE });
			initializeFormState();
		});
	} else {
		setupDetectedTimezoneOption({ defaultTimezone: DEFAULT_TIMEZONE });
		initializeFormState();
	}
</script>

