---
import PhoneInput from "../profile/PhoneInput.vue";

interface Props {
	user: {
		alert_via_email: boolean;
		alert_via_sms: boolean;
		timezone: string | null;
		alert_start_hour: number;
		alert_end_hour: number;
		sms_opted_out: boolean;
		phone_verified: boolean;
		phone_country_code: string | null;
		phone_number: string | null;
	};
}

const { user } = Astro.props;

const US_TIMEZONES = [
	{ value: "America/New_York", label: "Eastern Time (ET)" },
	{ value: "America/Chicago", label: "Central Time (CT)" },
	{ value: "America/Denver", label: "Mountain Time (MT)" },
	{ value: "America/Phoenix", label: "Mountain Time - Arizona (MT)" },
	{ value: "America/Los_Angeles", label: "Pacific Time (PT)" },
	{ value: "America/Anchorage", label: "Alaska Time (AKT)" },
	{ value: "Pacific/Honolulu", label: "Hawaii Time (HT)" },
];

const hours = Array.from({ length: 24 }, (_, i) => i);
---

<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
	<h2 class="text-2xl font-bold text-gray-900 mb-4">Alert Settings</h2>
	
	<form method="POST" action="/api/alerts/update" class="space-y-6">
		<div class="space-y-4">
			<label class="block text-sm font-medium text-slate-700 mb-2">
				Alert Delivery Methods
			</label>
			<div class="space-y-4">
				<label class="flex items-center cursor-pointer">
					<input type="checkbox" name="alert_via_email" class="mr-2 cursor-pointer" checked={user.alert_via_email} />
					<span>Email Alerts</span>
				</label>
				
				<label class="flex items-center cursor-pointer">
					<input type="checkbox" name="alert_via_sms" class="mr-2 cursor-pointer" checked={user.alert_via_sms} />
					<span>Text Message Alerts</span>
				</label>
			
			{user.sms_opted_out && (
				<div class="ml-6 bg-red-50 border border-red-200 rounded-lg p-4">
					<p class="text-red-800 text-sm">You have opted out of text message alerts. Reply START to your last message to re-enable.</p>
				</div>
			)}
			
			{!user.sms_opted_out && (
				<div id="phone-verification-section" class={`ml-6 space-y-4 ${user.alert_via_sms ? '' : 'hidden'}`}>
					{user.phone_verified ? (
						<div class="bg-green-50 border border-green-200 rounded-lg p-4">
							<p class="text-green-800 text-sm">
								<span class="sr-only">Phone verified:</span>
								<span aria-hidden="true">âœ“</span>
								Phone verified: {user.phone_country_code} {user.phone_number}
							</p>
						</div>
					) : (
						<div class="space-y-4">
							<form method="POST" action="/api/auth/sms/send-verification" class="space-y-4">
								<PhoneInput client:only="vue" />
								<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm mt-4 cursor-pointer">
									Send Verification Code
								</button>
							</form>

						{user.phone_number && !user.phone_verified && (
							<form method="POST" action="/api/auth/sms/verify-code" class="space-y-4">
									<div>
										<label for="code" class="block text-sm font-medium text-slate-700 mb-2">
											Enter Verification Code
										</label>
										<input type="text" id="code" name="code" required
											maxlength="6" pattern="[0-9]{6}" inputmode="numeric"
											class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
											placeholder="123456" />
									</div>
									<button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm mt-4">
										Verify Code
									</button>
								</form>
							)}
						</div>
					)}
				</div>
			)}
		</div>

		<div class="mt-8 mb-8">
			<label for="timezone" class="block text-sm font-medium text-slate-700 mb-1">
				Timezone <span class="text-red-500">*</span>
			</label>
			<select id="timezone" name="timezone" required
				class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
				<option value="">Select your timezone</option>
				{US_TIMEZONES.map(tz => (
					<option value={tz.value} selected={user.timezone === tz.value}>
						{tz.label}
					</option>
				))}
			</select>
		</div>

		<div class="grid grid-cols-2 gap-4">
			<div>
				<label for="alert_start_hour" class="block text-sm font-medium text-slate-700 mb-1">
					Start Hour (24h format)
				</label>
				<select id="alert_start_hour" name="alert_start_hour"
					class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
					{hours.map(hour => (
						<option value={hour} selected={user.alert_start_hour === hour}>
							{String(hour).padStart(2, '0')}:00
						</option>
					))}
				</select>
			</div>
			<div>
				<label for="alert_end_hour" class="block text-sm font-medium text-slate-700 mb-1">
					End Hour (24h format)
				</label>
				<select id="alert_end_hour" name="alert_end_hour"
					class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer">
					{hours.map(hour => (
						<option value={hour} selected={user.alert_end_hour === hour}>
							{String(hour).padStart(2, '0')}:00
						</option>
					))}
				</select>
			</div>
		</div>

		<button type="submit" id="save-button" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer mt-6 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
			Save
		</button>
	</form>
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {

		// Handle SMS checkbox toggle
		const smsCheckbox = document.querySelector('input[name="alert_via_sms"]') as HTMLInputElement;
		const phoneVerificationSection = document.getElementById('phone-verification-section') as HTMLElement;
		
		if (smsCheckbox && phoneVerificationSection) {
			smsCheckbox.addEventListener('change', () => {
				phoneVerificationSection.classList.toggle('hidden', !smsCheckbox.checked);
			});
		}

		// Track form changes to enable/disable save button
		const saveButton = document.getElementById('save-button') as HTMLButtonElement;
		const form = document.querySelector('form') as HTMLFormElement;
		
		if (!saveButton || !form) return;

		// Store initial values AFTER all DOM manipulation is complete
		const initialValues = {
			alert_via_email: (document.querySelector('input[name="alert_via_email"]') as HTMLInputElement)?.checked || false,
			alert_via_sms: (document.querySelector('input[name="alert_via_sms"]') as HTMLInputElement)?.checked || false,
			timezone: (document.querySelector('select[name="timezone"]') as HTMLSelectElement)?.value || '',
			alert_start_hour: (document.querySelector('select[name="alert_start_hour"]') as HTMLSelectElement)?.value || '',
			alert_end_hour: (document.querySelector('select[name="alert_end_hour"]') as HTMLSelectElement)?.value || ''
		};

		function checkForChanges() {
			const currentValues = {
				alert_via_email: (document.querySelector('input[name="alert_via_email"]') as HTMLInputElement)?.checked || false,
				alert_via_sms: (document.querySelector('input[name="alert_via_sms"]') as HTMLInputElement)?.checked || false,
				timezone: (document.querySelector('select[name="timezone"]') as HTMLSelectElement)?.value || '',
				alert_start_hour: (document.querySelector('select[name="alert_start_hour"]') as HTMLSelectElement)?.value || '',
				alert_end_hour: (document.querySelector('select[name="alert_end_hour"]') as HTMLSelectElement)?.value || ''
			};

			const hasChanges = Object.keys(initialValues).some(key => 
				initialValues[key as keyof typeof initialValues] !== currentValues[key as keyof typeof currentValues]
			);

			saveButton.disabled = !hasChanges;
		}

		// Add change listeners to all form inputs
		form.addEventListener('change', checkForChanges);
		form.addEventListener('input', checkForChanges);

		// Initial check
		checkForChanges();
	});
</script>
