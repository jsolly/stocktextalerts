---
interface Props {
	emailEnabled: boolean;
	smsEnabled: boolean;
}

const { emailEnabled, smsEnabled } = Astro.props as Props;

const showSection = emailEnabled || smsEnabled;
---

{showSection && (
	<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-8">
		<h2 class="text-2xl font-bold text-gray-900 mb-4">Preview Notifications</h2>
		<p class="text-gray-600 mb-6">
			Send a preview notification to verify your settings. These will be sent
			immediately, regardless of your time window preferences.
		</p>

		<div class="flex gap-4">
			{emailEnabled && (
				<button
					id="preview-email-btn"
					type="button"
					class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
				>
					Send Preview Email
				</button>
			)}
			{smsEnabled && (
				<button
					id="preview-sms-btn"
					type="button"
					class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
				>
					Send Preview SMS
				</button>
			)}
		</div>

		<div
			id="preview-notification-feedback"
			class="mt-4 hidden p-3 rounded-lg text-sm"
			role="alert"
		>
		</div>
	</div>
)}

<script>
	function setAllButtonsDisabled(disabled: boolean) {
		const emailBtn = document.getElementById("preview-email-btn") as HTMLButtonElement | null;
		const smsBtn = document.getElementById("preview-sms-btn") as HTMLButtonElement | null;
		if (emailBtn) emailBtn.disabled = disabled;
		if (smsBtn) smsBtn.disabled = disabled;
	}

	function setupPreviewButton(
		btnId: string,
		type: import("../../lib/database.types").Enums<"delivery_method">,
	) {
		const btn = document.getElementById(btnId) as HTMLButtonElement;
		const feedback = document.getElementById("preview-notification-feedback");

		if (!btn || !feedback) return;

		btn.addEventListener("click", async () => {
			const originalText = btn.textContent;
			setAllButtonsDisabled(true);
			btn.textContent = "Sending...";
			feedback.classList.add("hidden");
			feedback.className = "mt-4 hidden p-3 rounded-lg text-sm";

			try {
				const res = await fetch("/api/notifications/preview", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ type }),
				});

				const data = await res.json();

				if (res.ok && data.success) {
					feedback.textContent = `Preview ${type === "email" ? "email" : "SMS"} sent successfully!`;
					feedback.classList.remove("hidden");
					feedback.classList.add("bg-green-50", "text-green-800");
				} else {
					throw new Error(data.error || "Failed to send");
				}
			} catch (error) {
				feedback.textContent =
					error instanceof Error ? error.message : "An error occurred";
				feedback.classList.remove("hidden");
				feedback.classList.add("bg-red-50", "text-red-800");
			} finally {
				setAllButtonsDisabled(false);
				btn.textContent = originalText;
			}
		});
	}

	const emailBtn = document.getElementById("preview-email-btn");
	const smsBtn = document.getElementById("preview-sms-btn");

	if (emailBtn) {
		setupPreviewButton("preview-email-btn", "email");
	}
	if (smsBtn) {
		setupPreviewButton("preview-sms-btn", "sms");
	}
</script>

