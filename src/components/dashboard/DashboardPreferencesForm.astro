---
import type { TimezoneOption } from "../../lib/timezones";
import PhoneInput from "../PhoneInput.vue";
import type { StockOption } from "./StockInput.vue";
import TrackedStocksPanel from "./TrackedStocksPanel.vue";

interface Props {
	user: {
		email_notifications_enabled: boolean;
		sms_notifications_enabled: boolean;
		timezone: string | null;
		notification_start_hour: number;
		notification_end_hour: number;
		notification_frequency: "hourly" | "daily";
		daily_notification_hour: number | null;
		breaking_news_enabled: boolean;
		breaking_news_threshold_percent: number | null;
		breaking_news_outside_window: boolean;
		sms_opted_out: boolean;
		phone_verified: boolean;
		phone_country_code: string | null;
		phone_number: string | null;
	};
	timezones: TimezoneOption[];
	isEditingPhone: boolean;
	stockOptions: StockOption[];
	initialSymbols: string[];
}

const { user, timezones, stockOptions, initialSymbols, isEditingPhone } =
	Astro.props as Props;

const hours = Array.from({ length: 24 }, (_, index) => index);
---

<form
	id="dashboard-preferences-form"
	method="POST"
	action="/api/preferences"
	class="space-y-6"
>
	<input
		type="hidden"
		name="tracked_stocks"
		value={JSON.stringify(initialSymbols)}
	/>
	<TrackedStocksPanel
		client:only="vue"
		stockOptions={stockOptions}
		initialSymbols={initialSymbols}
	/>

	<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
		<h2 class="text-2xl font-bold text-gray-900 mb-4">Notification Preferences</h2>

		<div class="space-y-6">
			<div class="space-y-4">
				<label class="block text-sm font-medium text-slate-700 mb-2">
					Notification Channels
				</label>
				<div class="space-y-4">
					<label class="flex items-center cursor-pointer">
						<input
							type="checkbox"
							name="email_notifications_enabled"
							class="mr-2 cursor-pointer"
							checked={user.email_notifications_enabled}
						/>
						<span>Email Notifications</span>
					</label>

					<label class="flex items-center cursor-pointer">
						<input
							type="checkbox"
							name="sms_notifications_enabled"
							class="mr-2 cursor-pointer"
							checked={user.sms_notifications_enabled}
						/>
						<span>SMS Notifications</span>
					</label>

					{user.sms_opted_out && (
						<div class="ml-6 bg-red-50 border border-red-200 rounded-lg p-4">
							<p class="text-red-800 text-sm">
								You have opted out of SMS notifications. To re-enable, reply
								START to any message from us or update your settings below.
							</p>
						</div>
					)}

					{!user.sms_opted_out && (
						<div
							id="phone-verification-section"
							class={`ml-6 space-y-4 ${user.sms_notifications_enabled ? "" : "hidden"}`}
						>
							{user.phone_verified ? (
								<div class="bg-green-50 border border-green-200 rounded-lg p-4">
									<p class="text-green-800 text-sm">
										<span class="sr-only">Phone verified:</span>
										<span aria-hidden="true">âœ“</span>
										Phone verified: {user.phone_country_code} {user.phone_number}
									</p>
								</div>
							) : (
								<fieldset
									id="phone-verification-fieldset"
									class="space-y-4"
									disabled={!user.sms_notifications_enabled}
								>
									<legend class="sr-only">Phone Verification</legend>

									{(!user.phone_country_code || !user.phone_number || isEditingPhone) && (
										<>
											<!-- PhoneInput sets a hidden phone_is_valid input used by updateSendButtonState -->
											<PhoneInput
												client:only="vue"
												required={user.sms_notifications_enabled}
												disabled={!user.sms_notifications_enabled}
												initialNationalNumber={user.phone_number}
											/>
											<button
												type="submit"
												formaction="/api/auth/sms/send-verification"
												formmethod="post"
												id="send-verification-button"
												disabled
												class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm mt-4 cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed"
											>
												Send Verification Code
											</button>
										</>
									)}

									{user.phone_country_code &&
										user.phone_number &&
										!user.phone_verified &&
										!isEditingPhone && (
											<>
												<div class="space-y-2">
													<p class="text-sm text-slate-700">
														We sent a code to{" "}
														<span class="font-medium">
															{user.phone_country_code} {user.phone_number}
														</span>
														.
													</p>
													<div class="flex items-center gap-4">
														<button
															type="submit"
															formaction="/api/auth/sms/send-verification"
															formmethod="post"
															class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm cursor-pointer"
														>
															Resend Verification Code
														</button>
														<a
															href="/dashboard?change_phone=1"
															class="text-sm text-blue-600 hover:underline"
														>
															Change number
														</a>
													</div>
												</div>

												<input
													type="hidden"
													name="phone_country_code"
													value={user.phone_country_code}
												/>
												<input
													type="hidden"
													name="phone_national_number"
													value={user.phone_number}
												/>

												<div class="space-y-4 mt-4">
													<div>
														<label
															for="code"
															class="block text-sm font-medium text-slate-700 mb-2"
														>
															Enter Verification Code
														</label>
														<input
															type="text"
															id="code"
															name="code"
															required={user.sms_notifications_enabled}
															disabled={!user.sms_notifications_enabled}
															autocomplete="one-time-code"
															maxlength="6"
															pattern="[0-9]{6}"
															inputmode="numeric"
															class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
															placeholder="123456"
														/>
													</div>
													<button
														type="submit"
														formaction="/api/auth/sms/verify-code"
														formmethod="post"
														class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm mt-4"
													>
														Verify Code
													</button>
												</div>
											</>
										)}
								</fieldset>
							)}
						</div>
					)}
				</div>
			</div>

			<div class="mt-8 mb-8">
				<label
					for="timezone"
					class="block text-sm font-medium text-slate-700 mb-1"
				>
					Timezone <span class="text-red-500">*</span>
				</label>
				<select
					id="timezone"
					name="timezone"
					required
					class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
				>
					<option value="">
						Select your timezone
					</option>
					{timezones.map((tz) => (
						<option value={tz.value} selected={user.timezone === tz.value}>
							{tz.label}
						</option>
					))}
				</select>
			</div>

			<div class="mt-8 mb-8">
				<label class="block text-sm font-medium text-slate-700 mb-2">
					Frequency
				</label>
				<div class="space-y-4">
					<div class="flex items-center gap-4">
						<label class="flex items-center cursor-pointer">
							<input
								type="radio"
								name="notification_frequency"
								value="hourly"
								class="mr-2 cursor-pointer"
								checked={user.notification_frequency === "hourly"}
							/>
							<span>Every hour</span>
						</label>
						<label class="flex items-center cursor-pointer">
							<input
								type="radio"
								name="notification_frequency"
								value="daily"
								class="mr-2 cursor-pointer"
								checked={user.notification_frequency === "daily"}
							/>
							<span>Once a day</span>
						</label>
					</div>
					
					<div
						id="daily-notification-hour-container"
						class={`ml-6 ${user.notification_frequency === "daily" ? "" : "hidden"}`}
					>
						<label
							for="daily_notification_hour"
							class="block text-sm font-medium text-slate-700 mb-1"
						>
							Preferred Hour (during window)
						</label>
						<select
							id="daily_notification_hour"
							name="daily_notification_hour"
							class="w-full max-w-xs px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
						>
							{hours.map((hour) => (
								<option
									value={hour}
									selected={(user.daily_notification_hour ?? user.notification_start_hour) === hour}
								>
									{String(hour).padStart(2, "0")}:00
								</option>
							))}
						</select>
						<div
							id="daily-hour-validation-error"
							class="hidden mt-2 text-sm text-red-600"
							role="alert"
						>
							Daily notification hour must be within your time window.
						</div>
					</div>
				</div>
			</div>

			<div class="grid grid-cols-2 gap-4">
				<div>
					<label
						for="notification_start_hour"
						class="block text-sm font-medium text-slate-700 mb-1"
					>
						Start Hour (24h format)
					</label>
					<select
						id="notification_start_hour"
						name="notification_start_hour"
						class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
					>
						{hours.map((hour) => (
							<option
								value={hour}
								selected={user.notification_start_hour === hour}
							>
								{String(hour).padStart(2, "0")}:00
							</option>
						))}
					</select>
				</div>
				<div>
					<label
						for="notification_end_hour"
						class="block text-sm font-medium text-slate-700 mb-1"
					>
						End Hour (24h format)
					</label>
					<select
						id="notification_end_hour"
						name="notification_end_hour"
						class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
					>
						{hours.map((hour) => (
							<option
								value={hour}
								selected={user.notification_end_hour === hour}
							>
								{String(hour).padStart(2, "0")}:00
							</option>
						))}
					</select>
					<div
						id="hour-validation-error"
						class="hidden mt-2 text-sm text-red-600"
						role="alert"
					>
						End hour must be greater than or equal to start hour.
					</div>
				</div>
			</div>

			<div class="mt-8 mb-8 border-t border-gray-200 pt-6">
				<h3 class="text-lg font-semibold text-gray-900 mb-4">Breaking News</h3>
				<div class="space-y-4">
					<label class="flex items-center cursor-pointer">
						<input
							type="checkbox"
							name="breaking_news_enabled"
							class="mr-2 cursor-pointer"
							checked={user.breaking_news_enabled}
						/>
						<span>Enable breaking news notifications</span>
					</label>

					<div
						id="breaking-news-settings"
						class={`ml-6 space-y-4 ${user.breaking_news_enabled ? "" : "hidden"}`}
					>
						<div>
							<label
								for="breaking_news_threshold_percent"
								class="block text-sm font-medium text-slate-700 mb-1"
							>
								Price Change Threshold (%)
							</label>
							<input
								type="number"
								id="breaking_news_threshold_percent"
								name="breaking_news_threshold_percent"
								min="0.1"
								max="100"
								step="0.1"
								value={user.breaking_news_threshold_percent ?? 5.0}
								class="w-32 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							/>
							<p class="text-xs text-gray-500 mt-1">
								Notify me when a stock moves more than this percentage in a short period.
							</p>
						</div>

						<label class="flex items-center cursor-pointer">
							<input
								type="checkbox"
								name="breaking_news_outside_window"
								class="mr-2 cursor-pointer"
								checked={user.breaking_news_outside_window}
							/>
							<span>Allow breaking news outside time window</span>
						</label>
					</div>
				</div>
			</div>

			<!-- Store initial tracked stocks for change detection.
			     The tracked_stocks hidden input is rendered by TrackedStocksPanel.vue. -->
			<button
				type="submit"
				id="save-button"
				class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer mt-6 disabled:bg-gray-400 disabled:cursor-not-allowed"
				data-initial-tracked-stocks={JSON.stringify(initialSymbols)}
				disabled
			>
				Save
			</button>
		</div>
	</div>
</form>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const form = document.getElementById(
			"dashboard-preferences-form",
		) as HTMLFormElement;
		if (!form) return;

		// Handle SMS checkbox toggle
		const smsCheckbox = form.querySelector(
			'input[name="sms_notifications_enabled"]',
		) as HTMLInputElement;
		const phoneVerificationSection = document.getElementById(
			"phone-verification-section",
		) as HTMLElement;
		const phoneVerificationFieldset = document.getElementById(
			"phone-verification-fieldset",
		) as HTMLFieldSetElement | null;

		if (smsCheckbox && phoneVerificationSection) {
			const updateSmsUI = () => {
				const enabled = smsCheckbox.checked;
				phoneVerificationSection.classList.toggle("hidden", !enabled);
				if (phoneVerificationFieldset) {
					phoneVerificationFieldset.disabled = !enabled;
				}
			};
			updateSmsUI();
			smsCheckbox.addEventListener("change", updateSmsUI);
		}

		const saveButton = document.getElementById(
			"save-button",
		) as HTMLButtonElement;
		if (!saveButton) return;
		const initialTrackedStocksJson =
			saveButton.dataset.initialTrackedStocks ?? "[]";

		function getTrackedStocksValue() {
			const input = form.querySelector(
				'input[name="tracked_stocks"]',
			) as HTMLInputElement | null;
			if (!input) {
				return initialTrackedStocksJson;
			}

			return input.value ?? "";
		}

		function readFormValues() {
			return {
				email_notifications_enabled: (
					form.querySelector(
						'input[name="email_notifications_enabled"]',
					) as HTMLInputElement
				)?.checked
					|| false,
				sms_notifications_enabled: (
					form.querySelector(
						'input[name="sms_notifications_enabled"]',
					) as HTMLInputElement
				)?.checked
					|| false,
				timezone:
					(
						form.querySelector(
							"select[name=\"timezone\"]",
						) as HTMLSelectElement
					)?.value || "",
				notification_start_hour:
					(
						form.querySelector(
							"select[name=\"notification_start_hour\"]",
						) as HTMLSelectElement
					)?.value || "",
				notification_end_hour:
					(
						form.querySelector(
							"select[name=\"notification_end_hour\"]",
						) as HTMLSelectElement
					)?.value || "",
				notification_frequency:
					(
						form.querySelector(
							'input[name="notification_frequency"]:checked',
						) as HTMLInputElement
					)?.value || "daily",
				daily_notification_hour:
					(
						form.querySelector(
							"select[name=\"daily_notification_hour\"]",
						) as HTMLSelectElement
					)?.value || "",
				breaking_news_enabled: (
					form.querySelector(
						'input[name="breaking_news_enabled"]',
					) as HTMLInputElement
				)?.checked
					|| false,
				breaking_news_threshold_percent:
					(
						form.querySelector(
							'input[name="breaking_news_threshold_percent"]',
						) as HTMLInputElement
					)?.value || "",
				breaking_news_outside_window: (
					form.querySelector(
						'input[name="breaking_news_outside_window"]',
					) as HTMLInputElement
				)?.checked
					|| false,
			};
		}

		const initialValues = readFormValues();

		function updateSendButtonState(targetForm: HTMLFormElement) {
			const sendButton = document.getElementById(
				"send-verification-button",
			) as HTMLButtonElement | null;
			if (!sendButton) {
				return;
			}

			const validField = targetForm.querySelector(
				'input[name="phone_is_valid"]',
			) as HTMLInputElement | null;
			const isValid = (validField?.value ?? "").toLowerCase() === "true";
			sendButton.disabled = !isValid;
		}

		function checkForChanges() {
			const currentValues = readFormValues();

			const hasPreferenceChanges = (
				Object.keys(initialValues) as Array<keyof typeof initialValues>
			).some((key) => {
				return initialValues[key] !== currentValues[key];
			});

			saveButton.disabled = !hasPreferenceChanges;
			updateSendButtonState(form);
		}

		// Listen for input changes on preference fields only (not tracked_stocks)
		// to enable/disable Save button and update phone verification button.
		form.addEventListener("input", (e) => {
			// Ignore changes to tracked_stocks input (handled separately)
			const target = e.target as HTMLElement;
			if (target.getAttribute("name") === "tracked_stocks") {
				return;
			}
			checkForChanges();
		});

		// Validate start/end hour relationship
		const startHourSelect = form.querySelector(
			'select[name="notification_start_hour"]',
		) as HTMLSelectElement;
		const endHourSelect = form.querySelector(
			'select[name="notification_end_hour"]',
		) as HTMLSelectElement;
		const hourValidationError = document.getElementById(
			"hour-validation-error",
		) as HTMLElement;
		const dailyHourSelect = form.querySelector(
			'select[name="daily_notification_hour"]',
		) as HTMLSelectElement;
		const dailyHourContainer = document.getElementById(
			"daily-notification-hour-container",
		) as HTMLElement;
		const dailyHourValidationError = document.getElementById(
			"daily-hour-validation-error",
		) as HTMLElement;

		// Frequency toggle logic
		const frequencyRadios = form.querySelectorAll(
			'input[name="notification_frequency"]',
		);
		frequencyRadios.forEach((radio) => {
			radio.addEventListener("change", (e) => {
				const target = e.target as HTMLInputElement;
				if (target.checked) {
					dailyHourContainer.classList.toggle("hidden", target.value !== "daily");
					validateDailyHour();
					checkForChanges();
				}
			});
		});

		// Breaking news toggle logic
		const breakingNewsCheckbox = form.querySelector(
			'input[name="breaking_news_enabled"]',
		) as HTMLInputElement;
		const breakingNewsSettings = document.getElementById(
			"breaking-news-settings",
		) as HTMLElement;
		
		if (breakingNewsCheckbox && breakingNewsSettings) {
			breakingNewsCheckbox.addEventListener("change", () => {
				breakingNewsSettings.classList.toggle("hidden", !breakingNewsCheckbox.checked);
				checkForChanges();
			});
		}

		function updateEndHourOptions() {
			if (!startHourSelect || !endHourSelect) return;

			const startHour = Number.parseInt(startHourSelect.value, 10);
			const currentEndHour = Number.parseInt(endHourSelect.value, 10);

			// Disable invalid options in end hour select
			Array.from(endHourSelect.options).forEach((option) => {
				const hour = Number.parseInt(option.value, 10);
				option.disabled = hour < startHour;
			});

			// If current end hour is invalid, adjust it
			if (currentEndHour < startHour) {
				endHourSelect.value = String(startHour);
				checkForChanges();
			}

			validateHourRelationship();
			updateDailyHourOptions();
		}

		function updateDailyHourOptions() {
			if (!startHourSelect || !endHourSelect || !dailyHourSelect) return;

			const startHour = Number.parseInt(startHourSelect.value, 10);
			const endHour = Number.parseInt(endHourSelect.value, 10);
			const currentDailyHour = Number.parseInt(dailyHourSelect.value, 10);

			// Disable invalid options in daily hour select
			Array.from(dailyHourSelect.options).forEach((option) => {
				const hour = Number.parseInt(option.value, 10);
				option.disabled = hour < startHour || hour > endHour;
			});

			// If current daily hour is invalid, adjust it to startHour
			if (currentDailyHour < startHour || currentDailyHour > endHour) {
				dailyHourSelect.value = String(startHour);
				checkForChanges();
			}
			
			validateDailyHour();
		}

		function validateDailyHour() {
			if (!startHourSelect || !endHourSelect || !dailyHourSelect || !dailyHourValidationError) return true;

			// Skip validation if frequency is not daily
			const frequency = (form.querySelector('input[name="notification_frequency"]:checked') as HTMLInputElement)?.value;
			if (frequency !== "daily") {
				dailyHourValidationError.classList.add("hidden");
				dailyHourSelect.classList.remove("border-red-500");
				dailyHourSelect.classList.add("border-slate-300");
				return true;
			}

			const startHour = Number.parseInt(startHourSelect.value, 10);
			const endHour = Number.parseInt(endHourSelect.value, 10);
			const dailyHour = Number.parseInt(dailyHourSelect.value, 10);
			
			const isValid = dailyHour >= startHour && dailyHour <= endHour;

			if (isValid) {
				dailyHourValidationError.classList.add("hidden");
				dailyHourSelect.classList.remove("border-red-500");
				dailyHourSelect.classList.add("border-slate-300");
			} else {
				dailyHourValidationError.classList.remove("hidden");
				dailyHourSelect.classList.remove("border-slate-300");
				dailyHourSelect.classList.add("border-red-500");
			}

			return isValid;
		}

		function validateHourRelationship() {
			if (!startHourSelect || !endHourSelect || !hourValidationError) return;

			const startHour = Number.parseInt(startHourSelect.value, 10);
			const endHour = Number.parseInt(endHourSelect.value, 10);
			const isValid = endHour >= startHour;

			if (isValid) {
				hourValidationError.classList.add("hidden");
				endHourSelect.classList.remove("border-red-500");
				endHourSelect.classList.add("border-slate-300");
			} else {
				hourValidationError.classList.remove("hidden");
				endHourSelect.classList.remove("border-slate-300");
				endHourSelect.classList.add("border-red-500");
			}

			return isValid;
		}

		if (startHourSelect && endHourSelect) {
			startHourSelect.addEventListener("change", () => {
				updateEndHourOptions();
				checkForChanges();
			});

			endHourSelect.addEventListener("change", () => {
				validateHourRelationship();
				updateDailyHourOptions();
				checkForChanges();
			});

			if (dailyHourSelect) {
				dailyHourSelect.addEventListener("change", () => {
					validateDailyHour();
					checkForChanges();
				});
			}

			// Initial validation and option update
			updateEndHourOptions();

			// Prevent form submission if hours are invalid
			form.addEventListener("submit", (e) => {
				const isHourRelValid = validateHourRelationship();
				const isDailyHourValid = validateDailyHour();
				
				if (!isHourRelValid) {
					e.preventDefault();
					endHourSelect.focus();
				} else if (!isDailyHourValid) {
					e.preventDefault();
					dailyHourSelect.focus();
				}
			});
		}

		checkForChanges();
	});
</script>


