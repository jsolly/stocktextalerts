---
import type { TimezoneOption } from "../../lib/timezones";
import PhoneInput from "../PhoneInput.vue";
import type { StockOption } from "./StockInput.vue";
import TrackedStocksPanel from "./TrackedStocksPanel.vue";

interface Props {
	user: {
		email_notifications_enabled: boolean;
		sms_notifications_enabled: boolean;
		timezone: string | null;
		notification_start_hour: number;
		notification_end_hour: number;
		sms_opted_out: boolean;
		phone_verified: boolean;
		phone_country_code: string | null;
		phone_number: string | null;
	};
	timezones: TimezoneOption[];
	stockOptions: StockOption[];
	initialSymbols: string[];
}

const { user, timezones, stockOptions, initialSymbols } = Astro.props as Props;

const hours = Array.from({ length: 24 }, (_, index) => index);
---

<form
	id="dashboard-preferences-form"
	method="POST"
	action="/api/preferences"
	class="space-y-6"
>
	<TrackedStocksPanel
		client:only="vue"
		stockOptions={stockOptions}
		initialSymbols={initialSymbols}
	/>

	<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
		<h2 class="text-2xl font-bold text-gray-900 mb-4">Notification Preferences</h2>

		<div class="space-y-6">
			<div class="space-y-4">
				<label class="block text-sm font-medium text-slate-700 mb-2">
					Notification Channels
				</label>
				<div class="space-y-4">
					<label class="flex items-center cursor-pointer">
						<input
							type="checkbox"
							name="email_notifications_enabled"
							class="mr-2 cursor-pointer"
							checked={user.email_notifications_enabled}
						/>
						<span>Email Notifications</span>
					</label>

					<label class="flex items-center cursor-pointer">
						<input
							type="checkbox"
							name="sms_notifications_enabled"
							class="mr-2 cursor-pointer"
							checked={user.sms_notifications_enabled}
						/>
						<span>SMS Notifications</span>
					</label>

					{user.sms_opted_out && (
						<div class="ml-6 bg-red-50 border border-red-200 rounded-lg p-4">
							<p class="text-red-800 text-sm">
								You have opted out of SMS notifications. To re-enable, reply
								START to any message from us or update your settings below.
							</p>
						</div>
					)}

					{!user.sms_opted_out && (
						<div
							id="phone-verification-section"
							class={`ml-6 space-y-4 ${user.sms_notifications_enabled ? "" : "hidden"}`}
						>
							{user.phone_verified ? (
								<div class="bg-green-50 border border-green-200 rounded-lg p-4">
									<p class="text-green-800 text-sm">
										<span class="sr-only">Phone verified:</span>
										<span aria-hidden="true">âœ“</span>
										Phone verified: {user.phone_country_code} {user.phone_number}
									</p>
								</div>
							) : (
								<fieldset
									id="phone-verification-fieldset"
									class="space-y-4"
									disabled={!user.sms_notifications_enabled}
								>
									<legend class="sr-only">Phone Verification</legend>
									<PhoneInput
										client:only="vue"
										required={user.sms_notifications_enabled}
										disabled={!user.sms_notifications_enabled}
									/>
									<button
										type="submit"
										formaction="/api/auth/sms/send-verification"
										formmethod="post"
										class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm mt-4 cursor-pointer"
									>
										Send Verification Code
									</button>

									{user.phone_number && !user.phone_verified && (
										<div class="space-y-4">
											<div>
												<label
													for="code"
													class="block text-sm font-medium text-slate-700 mb-2"
												>
													Enter Verification Code
												</label>
												<input
													type="text"
													id="code"
													name="code"
													required={user.sms_notifications_enabled}
													disabled={!user.sms_notifications_enabled}
													autocomplete="one-time-code"
													maxlength="6"
													pattern="[0-9]{6}"
													inputmode="numeric"
													class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
													placeholder="123456"
												/>
											</div>
											<button
												type="submit"
												formaction="/api/auth/sms/verify-code"
												formmethod="post"
												class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm mt-4"
											>
												Verify Code
											</button>
										</div>
									)}
								</fieldset>
							)}
						</div>
					)}
				</div>
			</div>

			<div class="mt-8 mb-8">
				<label
					for="timezone"
					class="block text-sm font-medium text-slate-700 mb-1"
				>
					Timezone <span class="text-red-500">*</span>
				</label>
				<select
					id="timezone"
					name="timezone"
					required
					class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
				>
					<option value="">
						Select your timezone
					</option>
					{timezones.map((tz) => (
						<option value={tz.value} selected={user.timezone === tz.value}>
							{tz.label}
						</option>
					))}
				</select>
			</div>

			<div class="grid grid-cols-2 gap-4">
				<div>
					<label
						for="notification_start_hour"
						class="block text-sm font-medium text-slate-700 mb-1"
					>
						Start Hour (24h format)
					</label>
					<select
						id="notification_start_hour"
						name="notification_start_hour"
						class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
					>
						{hours.map((hour) => (
							<option
								value={hour}
								selected={user.notification_start_hour === hour}
							>
								{String(hour).padStart(2, "0")}:00
							</option>
						))}
					</select>
				</div>
				<div>
					<label
						for="notification_end_hour"
						class="block text-sm font-medium text-slate-700 mb-1"
					>
						End Hour (24h format)
					</label>
					<select
						id="notification_end_hour"
						name="notification_end_hour"
						class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
					>
						{hours.map((hour) => (
							<option
								value={hour}
								selected={user.notification_end_hour === hour}
							>
								{String(hour).padStart(2, "0")}:00
							</option>
						))}
					</select>
				</div>
			</div>

			<!-- Store initial tracked stocks for change detection.
			     The tracked_stocks hidden input is rendered by TrackedStocksPanel.vue. -->
			<button
				type="submit"
				id="save-button"
				class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer mt-6 disabled:bg-gray-400 disabled:cursor-not-allowed"
				data-initial-tracked-stocks={JSON.stringify(initialSymbols)}
				disabled
			>
				Save
			</button>
		</div>
	</div>
</form>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const form = document.getElementById(
			"dashboard-preferences-form",
		) as HTMLFormElement;
		if (!form) return;

		// Handle SMS checkbox toggle
		const smsCheckbox = form.querySelector(
			'input[name="sms_notifications_enabled"]',
		) as HTMLInputElement;
		const phoneVerificationSection = document.getElementById(
			"phone-verification-section",
		) as HTMLElement;
		const phoneVerificationFieldset = document.getElementById(
			"phone-verification-fieldset",
		) as HTMLFieldSetElement | null;

		if (smsCheckbox && phoneVerificationSection) {
			const updateSmsUI = () => {
				const enabled = smsCheckbox.checked;
				phoneVerificationSection.classList.toggle("hidden", !enabled);
				if (phoneVerificationFieldset) {
					phoneVerificationFieldset.disabled = !enabled;
				}
			};
			updateSmsUI();
			smsCheckbox.addEventListener("change", updateSmsUI);
		}

		const saveButton = document.getElementById(
			"save-button",
		) as HTMLButtonElement;
		if (!saveButton) return;
		const initialTrackedStocksJson =
			saveButton.dataset.initialTrackedStocks ?? "[]";

		function getTrackedStocksValue() {
			const input = form.querySelector(
				'input[name="tracked_stocks"]',
			) as HTMLInputElement | null;
			if (!input) {
				return initialTrackedStocksJson;
			}

			return input.value ?? "";
		}

		function readFormValues() {
			return {
				email_notifications_enabled: (
					form.querySelector(
						'input[name="email_notifications_enabled"]',
					) as HTMLInputElement
				)?.checked
					|| false,
				sms_notifications_enabled: (
					form.querySelector(
						'input[name="sms_notifications_enabled"]',
					) as HTMLInputElement
				)?.checked
					|| false,
				timezone:
					(
						form.querySelector(
							"select[name=\"timezone\"]",
						) as HTMLSelectElement
					)?.value || "",
				notification_start_hour:
					(
						form.querySelector(
							"select[name=\"notification_start_hour\"]",
						) as HTMLSelectElement
					)?.value || "",
				notification_end_hour:
					(
						form.querySelector(
							"select[name=\"notification_end_hour\"]",
						) as HTMLSelectElement
					)?.value || "",
				tracked_stocks: getTrackedStocksValue(),
			};
		}

		const initialValues = readFormValues();

		function checkForChanges() {
			const currentValues = readFormValues();

			const hasPreferenceChanges = (
				Object.keys(initialValues) as Array<keyof typeof initialValues>
			).some((key) => {
				return initialValues[key] !== currentValues[key];
			});

			saveButton.disabled = !hasPreferenceChanges;
		}

		// Listen for input changes on any form field, including tracked_stocks,
		// to enable/disable Save button.
		form.addEventListener("input", () => {
			checkForChanges();
		});

		checkForChanges();
	});
</script>


