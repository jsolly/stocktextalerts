---
import type { User } from "../../../lib/users";

interface Props {
	user: User;
}

const { user } = Astro.props;

function minutesToTimeInputValue(minutes: number): string {
	const hours = Math.floor(minutes / 60);
	const mins = minutes % 60;
	return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
}

const currentTime = minutesToTimeInputValue(
	user.daily_digest_notification_time,
);
---

<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
	<h2 class="text-2xl font-bold text-gray-900 mb-4">
		Scheduled Notifications
	</h2>

	<div class="space-y-6">
		<div>
			<div class="flex items-baseline justify-between gap-4">
				<h3 class="text-base font-semibold text-gray-900">Daily Digest</h3>
				<span class="text-xs text-gray-500">Once per day</span>
			</div>
			<p class="text-sm text-gray-600 mt-1">
				A summary of your tracked stocks, delivered using your selected
				notification channels.
			</p>

			<div class="mt-4 space-y-3">
				<label class="flex items-center cursor-pointer">
					<input
						type="checkbox"
						id="daily_digest_enabled"
						name="daily_digest_enabled"
						class="mr-2 cursor-pointer"
						checked={user.daily_digest_enabled}
					/>
					<span class="text-sm font-medium text-slate-700">
						Enable Daily Digest
					</span>
				</label>

				<div id="daily-digest-settings" class="ml-6 space-y-2">
					<label
						for="daily_digest_notification_time"
						class="block text-sm font-medium text-slate-700"
					>
						Daily digest time
					</label>
					<input
						type="time"
						id="daily_digest_notification_time"
						name="daily_digest_notification_time"
						value={currentTime}
						min="00:00"
						max="23:45"
						step="900"
						class="w-full max-w-xs px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
						disabled={!user.daily_digest_enabled}
					/>
					<p class="text-xs text-gray-500">
						This uses your configured timezone. Delivery runs every 15 minutes,
						so it may arrive a little after the selected time.
					</p>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	function setupDailyDigestUI() {
		const formElement = document.getElementById("dashboard-preferences-form");
		if (!(formElement instanceof HTMLFormElement)) {
			return;
		}

		const enabledCheckbox = formElement.querySelector(
			'input[name="daily_digest_enabled"]',
		);
		const timeInput = formElement.querySelector(
			'input[name="daily_digest_notification_time"]',
		);

		if (
			!(enabledCheckbox instanceof HTMLInputElement) ||
			!(timeInput instanceof HTMLInputElement)
		) {
			return;
		}

		const update = () => {
			timeInput.disabled = !enabledCheckbox.checked;
		};

		update();
		enabledCheckbox.addEventListener("change", update);
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", setupDailyDigestUI);
	} else {
		setupDailyDigestUI();
	}
</script>

