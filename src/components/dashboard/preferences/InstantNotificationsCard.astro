---
import type { UserStock } from "../../../lib/stocks";
import type { User } from "../../../lib/users";

interface Props {
	user: User;
	userStocks: UserStock[];
}

const { user, userStocks } = Astro.props as Props;
---

<div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
	<h2 class="text-2xl font-bold text-gray-900 mb-4">Instant Notifications</h2>
	<p class="text-sm text-gray-600 mb-6">
		Get notified immediately when important events occur, regardless of when you get your daily digest.
	</p>

	<div class="space-y-6">
		<!-- Breaking News Section -->
		<div class="border-b border-gray-200 pb-6">
			<label class="flex items-center cursor-pointer">
				<input
					type="checkbox"
					name="breaking_news_enabled"
					class="mr-2 cursor-pointer"
					checked={user.breaking_news_enabled}
				/>
				<span class="font-medium">Breaking News Alerts</span>
			</label>
			<p class="text-sm text-gray-500 mt-1 ml-6">
				Get notified when your tracked stocks are mentioned in breaking news or are trending on social media.
			</p>
		</div>

		<!-- Stock Trend Alerts Section -->
		<div class="border-b border-gray-200 pb-6">
			<div class="flex items-baseline justify-between gap-4">
				<h3 class="text-base font-semibold text-gray-900">Stock Trend Alerts</h3>
				<span class="text-xs text-gray-500">Instant</span>
			</div>
			<p class="text-sm text-gray-500 mt-1 ml-6">
				Track significant trends and patterns in your tracked stocks.
			</p>

			<div class="ml-6 mt-4 space-y-3">
				<label class="flex items-center cursor-pointer">
					<input
						type="checkbox"
						id="price_threshold_alerts_enabled"
						name="price_threshold_alerts_enabled"
						class="mr-2 cursor-pointer"
						checked={user.price_threshold_alerts_enabled}
					/>
					<span class="text-sm">Price threshold alerts</span>
				</label>
				<p class="text-xs text-gray-500 ml-6">
					Alerts when stocks cross your configured price thresholds.
				</p>

				<div
					id="price-threshold-settings"
					class="ml-6 mt-4 space-y-3 overflow-hidden transition-all duration-300 ease-in-out"
					data-expanded={user.price_threshold_alerts_enabled}
					style={user.price_threshold_alerts_enabled ? undefined : "max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0;"}
				>
					{userStocks.length === 0 ? (
						<p class="text-sm text-gray-500">
							Add stocks to configure price thresholds.
						</p>
					) : (
						<div class="space-y-4">
							<p class="text-sm font-medium text-gray-700">
								Configure price thresholds for your tracked stocks:
							</p>
							<div class="space-y-3">
								{userStocks.map((stock) => {
									const hardcodedPrice = 150.0;
									return (
										<div
											class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
										>
											<div class="flex items-center gap-4 flex-1">
												<span class="font-medium text-gray-900 min-w-[80px]">
													{stock.symbol}
												</span>
												<label
													class="flex items-center gap-2 flex-1"
													for={`price_threshold_${stock.symbol}`}
												>
													<span class="text-sm text-gray-600">Threshold:</span>
													<span class="text-xs text-gray-500">$</span>
													<input
														type="number"
														id={`price_threshold_${stock.symbol}`}
														name={`price_threshold_${stock.symbol}`}
														value={hardcodedPrice}
														step="0.01"
														min="0"
														class="w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
														disabled={!user.price_threshold_alerts_enabled}
													/>
												</label>
											</div>
										</div>
									);
								})}
							</div>
						</div>
					)}
				</div>

				<label class="flex items-center cursor-pointer">
					<input
						type="checkbox"
						name="volume_spike_alerts_enabled"
						class="mr-2 cursor-pointer"
						checked={user.volume_spike_alerts_enabled}
					/>
					<span class="text-sm">Volume spike alerts</span>
				</label>
				<p class="text-xs text-gray-500 ml-6">
					Detects unusually high trading volume activity.
				</p>
			</div>
		</div>
	</div>
</div>

<script>
	function setupPriceThresholdUI() {
		const formElement = document.getElementById("dashboard-preferences-form");
		if (!(formElement instanceof HTMLFormElement)) {
			return;
		}

		const enabledCheckbox = formElement.querySelector(
			'input[name="price_threshold_alerts_enabled"]',
		);
		const settingsContainer = formElement.querySelector(
			"#price-threshold-settings",
		);
		const priceInputs = settingsContainer
			? Array.from(settingsContainer.querySelectorAll('input[name^="price_threshold_"]'))
			: [];

		if (
			!(enabledCheckbox instanceof HTMLInputElement) ||
			!(settingsContainer instanceof HTMLElement)
		) {
			return;
		}

		let isInitialized = false;

		const initialize = () => {
			const isEnabled = enabledCheckbox.checked;
			
			if (isEnabled) {
				const scrollHeight = settingsContainer.scrollHeight;
				if (scrollHeight > 0) {
					settingsContainer.style.maxHeight = scrollHeight + "px";
					settingsContainer.style.opacity = "1";
				}
			}

			priceInputs.forEach((input) => {
				if (input instanceof HTMLInputElement) {
					input.disabled = !isEnabled;
				}
			});

			isInitialized = true;
		};

		const update = () => {
			if (!isInitialized) {
				return;
			}

			const isEnabled = enabledCheckbox.checked;
			
			if (isEnabled) {
				settingsContainer.removeAttribute("data-expanded");
				settingsContainer.style.paddingTop = "";
				settingsContainer.style.paddingBottom = "";
				settingsContainer.style.marginTop = "";
				settingsContainer.style.marginBottom = "";
				settingsContainer.style.maxHeight = "none";
				const scrollHeight = settingsContainer.scrollHeight;
				settingsContainer.style.maxHeight = "0";
				settingsContainer.offsetHeight;
				requestAnimationFrame(() => {
					settingsContainer.style.maxHeight = scrollHeight + "px";
					settingsContainer.style.opacity = "1";
				});
			} else {
				settingsContainer.setAttribute("data-expanded", "false");
				const currentHeight = settingsContainer.scrollHeight || settingsContainer.offsetHeight;
				if (currentHeight > 0) {
					settingsContainer.style.maxHeight = currentHeight + "px";
					settingsContainer.offsetHeight;
				}
				requestAnimationFrame(() => {
					settingsContainer.style.maxHeight = "0";
					settingsContainer.style.opacity = "0";
					settingsContainer.style.paddingTop = "0";
					settingsContainer.style.paddingBottom = "0";
					settingsContainer.style.marginTop = "0";
					settingsContainer.style.marginBottom = "0";
				});
			}

			priceInputs.forEach((input) => {
				if (input instanceof HTMLInputElement) {
					input.disabled = !isEnabled;
				}
			});
		};

		initialize();
		enabledCheckbox.addEventListener("change", update);
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", setupPriceThresholdUI);
	} else {
		setupPriceThresholdUI();
	}
</script>
